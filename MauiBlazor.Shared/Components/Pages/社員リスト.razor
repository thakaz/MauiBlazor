@page "/employeelist"
@attribute [Authorize]

<h3>社員リスト</h3>

<FluentTextField @bind-Value=社員番号 Label="社員番号"></FluentTextField>
<FluentTextField @bind-Value=名前 Label="名前"></FluentTextField>
<FluentButton OnClick="社員追加ボタンクリック時">社員追加</FluentButton>

@if (社員s.Count > 0)
{


    <FluentDataGrid Items="@(社員s.AsQueryable())">
        <PropertyColumn Property="@(p => p.Id)" Sortable="true" />
        <PropertyColumn Property="@(p => p.社員番号)" Sortable="true" />
        <PropertyColumn Property="@(p => p.名前)" Sortable="true" />
        <PropertyColumn Property="@(p => p.入社年度)" Sortable="true" />
        <PropertyColumn Property="@(p => p.備考)" Sortable="true" />
        <TemplateColumn Title="明細">
            <FluentButton OnClick="() => 社員明細ボタンクリック時(context)">明細</FluentButton>
        </TemplateColumn>

        <TemplateColumn Title="削除">
            <FluentButton OnClick="() => 社員削除ボタンクリック時(context)">削除</FluentButton>
        </TemplateColumn>
    </FluentDataGrid>
}

@code {

    private string? 社員番号 { get; set; }
    private string? 名前 { get; set; }

    private string? 組織コード { get; set; }
    private 組織? my組織 { get; set; }

    IList<社員> 社員s { get; set; } = new List<社員>();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            //組織コードを取得
            組織コード = AuthenticationStateProvider.Get組織コード();

            my組織 = await 組織Repository.GetBy組織コードAsync(組織コード);

            社員s = (await 社員Repository.Get組織メンバーAsync(組織コード)).ToList();

        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
        }

    }

    private async Task 社員追加ボタンクリック時(MouseEventArgs args)
    {
        try
        {
            if (string.IsNullOrWhiteSpace(社員番号) || string.IsNullOrWhiteSpace(名前))
            {
                return;
            }

            var new社員 = await 社員Repository.AddAsync(new 社員 { 社員番号 = 社員番号, 名前 = 名前, 組織Id = my組織.Id });
            社員s.Add(new社員);
        }
        catch (Exception e)
        {
            await DisplayAlert.ShowAlertAsync("エラー", e.Message + e.InnerException, "OK");

        }
    }

    private void 社員明細ボタンクリック時(社員 社員)
    {
        NavManager.NavigateTo($"employeedetail/{社員.Id}");
    }

    private async Task 社員削除ボタンクリック時(社員 社員)
    {
        //一応警告メッセージ
        var result = await DisplayAlert.ShowAlertAsync("削除", "削除しますか？", "OK", "キャンセル");

        if (!result)
        {
            return;
        }

        if (社員 is not null)
        {
            社員s.Remove(社員);
            await 社員Repository.DeleteAsync(社員.Id);
        }
    }

}
